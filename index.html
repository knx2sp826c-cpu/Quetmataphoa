<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>T·∫°p Ho√° Ng·∫°i H∆∞·ªùng - Cloud v1</title>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<style>
  :root { --primary: #007aff; --success: #34c759; --danger: #ff3b30; --bg: #f2f2f7; }
  body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; padding-bottom: 120px; }
  .header { text-align: center; background: white; padding: 15px; border-radius: 15px; margin-bottom: 10px; position: relative;}
  .sync-status { position: absolute; top: 5px; right: 10px; font-size: 10px; color: #666; }
  #camera-box { width: 100%; height: 180px; background: #000; border-radius: 15px; overflow: hidden; margin-bottom: 10px; border: 3px solid var(--primary); }
  video { width: 100%; height: 100%; object-fit: cover; }
  .card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 10px; }
  #new-product-area { display: none; background: #fff9c4; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 2px solid #fbc02d; }
  input { width: 100%; font-size: 20px; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
  .item-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 2px solid #f2f2f7; }
  .item-name { flex: 1; font-size: 18px; font-weight: bold; }
  .qty-control { display: flex; align-items: center; gap: 10px; }
  .btn-qty { width: 45px; height: 45px; background: #eee; border: none; border-radius: 10px; font-size: 25px; font-weight: bold; color: var(--primary); }
  .qty-num { font-size: 30px; font-weight: 800; min-width: 35px; text-align: center; }
  .footer-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; border-top: 2px solid #ddd; z-index: 100; }
  .total-flex { display: flex; justify-content: space-between; font-size: 24px; font-weight: 900; color: var(--danger); margin-bottom: 10px; }
  .btn-main { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 12px; font-size: 18px; font-weight: bold; width: 100%; }
  #invoice-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; padding: 20px; overflow-y: auto; }
  .no-print { display: block; }
  @media print { .no-print { display: none; } }
</style>
</head>
<body>

<div class="no-print">
  <div class="header">
    <span id="cloud-status" class="sync-status">ƒêang t·∫£i d·ªØ li·ªáu...</span>
    <h1>üè™ T·∫†P HO√Å NG·∫†I H∆Ø·ªúNG</h1>
  </div>

  <div id="camera-box"><video id="video" playsinline></video></div>

  <div class="card">
    <div id="new-product-area">
      <b style="color:red">H√ÄNG M·ªöI CH∆ØA C√ì GI√Å!</b>
      <input id="in-name" type="text" placeholder="T√™n s·∫£n ph·∫©m..." />
      <input id="in-price" type="number" placeholder="Gi√° b√°n..." />
      <button class="btn-main" style="background:var(--success)" onclick="saveToCloud()">‚úîÔ∏è L∆ØU L√äN H·ªÜ TH·ªêNG</button>
    </div>
    <div id="cart-list"></div>
  </div>

  <div class="footer-bar">
    <div class="total-flex"><span>T·ªîNG:</span><span id="bill-total">0 ‚Ç´</span></div>
    <button class="btn-main" onclick="showInvoice()">‚úÖ THANH TO√ÅN & IN ƒê∆†N</button>
  </div>
</div>

<div id="invoice-modal">
    <div style="text-align:center; border-bottom:1px dashed #000; padding-bottom:10px; font-family: monospace;">
        <h2 style="margin:0">T·∫†P HO√Å NG·∫†I H∆Ø·ªúNG</h2>
        <p id="inv-time"></p>
        <table style="width:100%; margin-top:15px; border-collapse: collapse;">
            <thead><tr style="border-bottom:1px solid #000"><th>M√≥n</th><th>SL</th><th style="text-align:right">Ti·ªÅn</th></tr></thead>
            <tbody id="inv-body"></tbody>
        </table>
        <div style="font-size:22px; font-weight:bold; text-align:right; margin-top:15px;">T·ªîNG: <span id="inv-total">0</span> ‚Ç´</div>
        <div class="no-print">
          <button class="btn-main" onclick="window.print()" style="background:#555; margin-top:20px;">üñ®Ô∏è IN H√ìA ƒê∆†N</button>
          <button class="btn-main" onclick="closeAndReset()" style="margin-top:10px;">XONG - TI·∫æP T·ª§C QU√âT</button>
        </div>
    </div>
</div>

<script>
// --- C·∫§U H√åNH API ---
const API_URL = "https://sheetdb.io/api/v1/t1ar7qsc5fvzy"; 

let globalProds = {};
let cart = [];
let scanLock = false;
const codeReader = new ZXing.BrowserBarcodeReader();

// T·∫£i d·ªØ li·ªáu t·ª´ Sheet khi m·ªü app
async function loadCloudData() {
    try {
        const res = await fetch(API_URL);
        const data = await res.json();
        data.forEach(item => {
            globalProds[item.Barcode] = { name: item.Name, price: parseInt(item.Price) };
        });
        document.getElementById("cloud-status").innerText = "‚óè ƒê√£ ƒë·ªìng b·ªô Cloud";
        document.getElementById("cloud-status").style.color = "green";
    } catch (e) {
        document.getElementById("cloud-status").innerText = "‚óè Offline (L·ªói k·∫øt n·ªëi)";
        document.getElementById("cloud-status").style.color = "red";
    }
}

window.addEventListener('load', () => {
    loadCloudData();
    startCamera();
});

function startCamera() {
    codeReader.decodeFromVideoDevice(null, 'video', (result) => {
        if (result && !scanLock) {
            const code = result.text;
            scanLock = true;
            if (globalProds[code]) {
                addItemToCart(globalProds[code].name, globalProds[code].price, code);
                setTimeout(() => { scanLock = false; }, 1500); // ƒê·ª£i 1.5s m·ªõi cho qu√©t m√≥n ti·∫øp
            } else {
                window.activeBarcode = code;
                document.getElementById("new-product-area").style.display = "block";
                document.getElementById("in-name").focus();
            }
        }
    });
}

async function saveToCloud() {
    const name = document.getElementById("in-name").value;
    const price = document.getElementById("in-price").value;
    if(!name || !price) return alert("Nh·∫≠p ƒë·ªß t√™n v√† gi√°!");

    const newProd = { Barcode: window.activeBarcode, Name: name, Price: price };
    document.getElementById("cloud-status").innerText = "‚óè ƒêang l∆∞u...";

    try {
        await fetch(API_URL, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ data: [newProd] })
        });
        globalProds[window.activeBarcode] = { name, price: parseInt(price) };
        addItemToCart(name, parseInt(price), window.activeBarcode);
        document.getElementById("new-product-area").style.display = "none";
        document.getElementById("in-name").value = "";
        document.getElementById("in-price").value = "";
        scanLock = false;
        document.getElementById("cloud-status").innerText = "‚óè ƒê√£ l∆∞u Cloud";
    } catch (e) { alert("L·ªói l∆∞u Cloud!"); }
}

function addItemToCart(name, price, barcode) {
    const item = cart.find(i => i.barcode === barcode);
    if (item) { item.qty += 1; } 
    else { cart.push({ barcode, name, price, qty: 1 }); }
    updateUI();
}

function updateUI() {
    const list = document.getElementById("cart-list");
    let total = 0; let html = "";
    cart.forEach((item, i) => {
        const sub = item.price * item.qty;
        total += sub;
        html += `<div class="item-row">
            <div class="item-name">${item.name}<br><small>${item.price.toLocaleString()}‚Ç´</small></div>
            <div class="qty-control">
                <button class="btn-qty" onclick="changeQty(${i}, -1)">-</button>
                <span class="qty-num">${item.qty}</span>
                <button class="btn-qty" onclick="changeQty(${i}, 1)">+</button>
            </div>
            <div style="font-weight:bold; width:90px; text-align:right">${sub.toLocaleString()}‚Ç´</div>
        </div>`;
    });
    list.innerHTML = html || '<p style="text-align:center; padding:20px; color:#999;">ƒêang ch·ªù qu√©t...</p>';
    document.getElementById("bill-total").innerText = total.toLocaleString() + " ‚Ç´";
}

function changeQty(idx, amt) {
    cart[idx].qty += amt;
    if (cart[idx].qty <= 0) cart.splice(idx, 1);
    updateUI();
}

function showInvoice() {
    if (cart.length === 0) return;
    scanLock = true;
    document.getElementById("inv-time").innerText = new Date().toLocaleString('vi-VN');
    let invHtml = ""; let total = 0;
    cart.forEach(item => {
        const sub = item.price * item.qty; total += sub;
        invHtml += `<tr><td>${item.name}</td><td style="text-align:center">${item.qty}</td><td style="text-align:right">${sub.toLocaleString()}</td></tr>`;
    });
    document.getElementById("inv-body").innerHTML = invHtml;
    document.getElementById("inv-total").innerText = total.toLocaleString();
    document.getElementById("invoice-modal").style.display = "block";
}

function closeAndReset() {
    cart = []; updateUI();
    document.getElementById("invoice-modal").style.display = "none";
    scanLock = false;
    codeReader.reset();
    startCamera();
}
</script>
</body>
</html>
