<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>M√°y T√≠nh Ti·ªÅn T·∫°p Ho√°</title>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<style>
  body { font-family: -apple-system, sans-serif; background: #f4f4f9; padding: 15px; margin: 0; }
  .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
  input { width: 100%; font-size: 16px; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
  button { width: 100%; font-size: 16px; padding: 14px; margin: 5px 0; border: none; border-radius: 8px; font-weight: bold; }
  .btn-scan { background: #007aff; color: white; }
  .btn-add { background: #28a745; color: white; }
  .btn-finish { background: #fd7e14; color: white; margin-top: 15px; }
  .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
  .qty-box { display: flex; align-items: center; gap: 10px; }
  .btn-qty { width: 32px; height: 32px; background: #eee; border-radius: 50%; display: flex; justify-content: center; align-items: center; }
  .total-text { font-size: 20px; font-weight: bold; text-align: right; color: red; margin: 15px 0; }
  video { width: 100%; border-radius: 10px; display: none; margin-bottom: 10px; background: #000; }
</style>
</head>
<body>

<h2>üßæ M√ÅY T√çNH TI·ªÄN</h2>

<div class="card">
  <video id="v-camera" playsinline webkit-playsinline></video>
  <button class="btn-scan" onclick="invokeScanner()">üì∑ QU√âT M√É V·∫†CH</button>
  
  <input id="in-name" type="text" placeholder="T√™n s·∫£n ph·∫©m (B·∫Øt bu·ªôc)" />
  <input id="in-price" type="number" placeholder="Gi√° b√°n (‚Ç´)" />
  <input id="in-qty" type="number" value="1" placeholder="S·ªë l∆∞·ª£ng" />
  
  <button class="btn-add" onclick="handleAddItem()">‚ûï TH√äM V√ÄO GI·ªé</button>
</div>

<div class="card">
  <div id="display-list"><i>Gi·ªè h√†ng tr·ªëng...</i></div>
  <div class="total-text" id="display-total">T·ªîNG: 0 ‚Ç´</div>
  <button class="btn-finish" onclick="handleFinishBill()">‚úÖ L∆ØU H√ìA ƒê∆†N</button>
</div>

<div class="card">
  <h3>üìö L·ªãch s·ª≠ h√¥m nay</h3>
  <div id="display-history"></div>
</div>

<script>
let currentBill = [];
let scannedBarcode = null;

// Kh·ªüi t·∫°o d·ªØ li·ªáu t·ª´ LocalStorage
const savedProducts = JSON.parse(localStorage.getItem("products") || "{}");
const savedBills = JSON.parse(localStorage.getItem("bills") || "{}");
const dateStr = new Date().toLocaleDateString("vi-VN");
if (!savedBills[dateStr]) savedBills[dateStr] = [];

function invokeScanner() {
  const v = document.getElementById("v-camera");
  v.style.display = "block";
  const codeReader = new ZXing.BrowserBarcodeReader();
  codeReader.decodeFromVideoDevice(null, "v-camera", (result, error) => {
    if (result) {
      codeReader.reset();
      v.style.display = "none";
      scannedBarcode = result.text;
      
      if (savedProducts[scannedBarcode]) {
        document.getElementById("in-name").value = savedProducts[scannedBarcode].name;
        document.getElementById("in-price").value = savedProducts[scannedBarcode].price;
      } else {
        document.getElementById("in-name").value = "";
        document.getElementById("in-price").value = "";
        alert("M√£ m·ªõi: " + scannedBarcode);
      }
    }
  });
}

function handleAddItem() {
  const elName = document.getElementById("in-name");
  const elPrice = document.getElementById("in-price");
  const elQty = document.getElementById("in-qty");

  const nameValue = elName.value.trim();
  const priceValue = parseInt(elPrice.value);
  const qtyValue = parseInt(elQty.value);

  if (!nameValue || isNaN(priceValue) || isNaN(qtyValue) || qtyValue <= 0) {
    alert("Vui l√≤ng nh·∫≠p ƒê·∫¶Y ƒê·ª¶ T√™n, Gi√° v√† S·ªë l∆∞·ª£ng!");
    return;
  }

  // L∆∞u v√†o "T·ª´ ƒëi·ªÉn" s·∫£n ph·∫©m
  if (scannedBarcode) {
    savedProducts[scannedBarcode] = { name: nameValue, price: priceValue };
    localStorage.setItem("products", JSON.stringify(savedProducts));
  }

  // Th√™m v√†o gi·ªè h√†ng
  currentBill.push({ name: nameValue, price: priceValue, qty: qtyValue });

  // Reset form nh·∫≠p
  elName.value = "";
  elPrice.value = "";
  elQty.value = "1";
  scannedBarcode = null;

  updateDisplay();
}

function modifyQty(idx, amount) {
  currentBill[idx].qty += amount;
  if (currentBill[idx].qty <= 0) currentBill.splice(idx, 1);
  updateDisplay();
}

function updateDisplay() {
  const listEl = document.getElementById("display-list");
  let totalSum = 0;
  let htmlContent = "";

  currentBill.forEach((item, i) => {
    const subTotal = item.price * item.qty;
    totalSum += subTotal;
    htmlContent += `
      <div class="item-row">
        <div><b>${item.name}</b><br><small>${item.price.toLocaleString()}‚Ç´</small></div>
        <div class="qty-box">
          <button class="btn-qty" onclick="modifyQty(${i}, -1)">-</button>
          <span>${item.qty}</span>
          <button class="btn-qty" onclick="modifyQty(${i}, 1)">+</button>
        </div>
        <div style="width: 80px; text-align: right;">${subTotal.toLocaleString()}‚Ç´</div>
      </div>`;
  });

  listEl.innerHTML = htmlContent || "<i>Gi·ªè h√†ng tr·ªëng...</i>";
  document.getElementById("display-total").innerText = "T·ªîNG: " + totalSum.toLocaleString() + " ‚Ç´";
}

function handleFinishBill() {
  if (currentBill.length === 0) return;
  const totalBill = currentBill.reduce((acc, cur) => acc + (cur.price * cur.qty), 0);
  savedBills[dateStr].push({ time: new Date().toLocaleTimeString(), total: totalBill });
  localStorage.setItem("bills", JSON.stringify(savedBills));
  
  currentBill = [];
  updateDisplay();
  renderHistoryView();
  alert("H√≥a ƒë∆°n ƒë√£ ƒë∆∞·ª£c l∆∞u!");
}

function renderHistoryView() {
  const histEl = document.getElementById("display-history");
  let html = "";
  if (savedBills[dateStr]) {
    savedBills[dateStr].forEach(b => {
      html += `<div style="font-size:14px; color:#555;">üïí ${b.time} - <b>${b.total.toLocaleString()}‚Ç´</b></div>`;
    });
  }
  histEl.innerHTML = html || "Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.";
}

renderHistoryView();
</script>
</body>
</html>
