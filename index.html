<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>T·∫°p Ho√° Ng·∫°i H∆∞·ªùng - Super Fast</title>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<style>
  :root { --primary: #007aff; --success: #34c759; --danger: #ff3b30; --bg: #f2f2f7; }
  body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; overflow-x: hidden; }
  
  /* Header g·ªçn h∆°n */
  .header { text-align: center; background: white; padding: 10px; border-radius: 12px; margin-bottom: 8px; position: relative; }
  .sync-status { position: absolute; top: 5px; right: 10px; font-size: 10px; font-weight: bold; }

  /* Camera t·ªëi ∆∞u */
  #camera-box { width: 100%; height: 160px; background: #000; border-radius: 12px; overflow: hidden; margin-bottom: 8px; border: 2px solid var(--primary); }
  video { width: 100%; height: 100%; object-fit: cover; }

  .card { background: white; padding: 12px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 8px; }
  
  /* √î nh·∫≠p h√†ng m·ªõi */
  #new-product-area { display: none; background: #fff9c4; padding: 12px; border-radius: 10px; margin-bottom: 10px; border: 2px solid #fbc02d; }
  input { width: 100%; font-size: 18px; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
  
  /* Danh s√°ch h√†ng TO & R√ï */
  .item-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
  .item-info { flex: 1; }
  .item-name { font-size: 18px; font-weight: bold; display: block; }
  .item-price { font-size: 14px; color: #666; }
  
  .qty-control { display: flex; align-items: center; gap: 12px; margin: 0 10px; }
  .btn-qty { width: 42px; height: 42px; background: #eee; border: none; border-radius: 10px; font-size: 24px; font-weight: bold; color: var(--primary); }
  .qty-num { font-size: 28px; font-weight: 800; min-width: 30px; text-align: center; }

  /* Thanh to√°n c·ªë ƒë·ªãnh */
  .footer-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 12px; border-top: 1px solid #ddd; z-index: 100; }
  .total-flex { display: flex; justify-content: space-between; font-size: 22px; font-weight: 900; color: var(--danger); margin-bottom: 8px; }
  .btn-main { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 10px; font-size: 18px; font-weight: bold; width: 100%; }

  /* H√ìA ƒê∆†N CHU·∫®N IN */
  #invoice-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; padding: 15px; box-sizing: border-box; overflow-y: auto; }
  .inv-paper { max-width: 350px; margin: 0 auto; color: #000; }
  .inv-header { text-align: center; border-bottom: 1px dashed #000; padding-bottom: 10px; }
  .inv-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  .inv-table th { border-bottom: 1px solid #000; font-size: 14px; padding: 5px 0; }
  .inv-table td { padding: 8px 0; font-size: 15px; vertical-align: top; }
  .inv-total { border-top: 2px double #000; margin-top: 10px; padding-top: 8px; font-size: 20px; font-weight: bold; text-align: right; }
  
  .no-print { display: block; }
  @media print { .no-print { display: none; } }
</style>
</head>
<body>

<div class="no-print">
  <div class="header">
    <span id="cloud-status" class="sync-status">‚óè ƒêang k·∫øt n·ªëi...</span>
    <h1 style="margin:0; font-size:20px; color:#d70119;">T·∫†P HO√Å NG·∫†I H∆Ø·ªúNG</h1>
  </div>

  <div id="camera-box"><video id="video" playsinline></video></div>

  <div class="card">
    <div id="new-product-area">
      <b style="color:red">M√ìN M·ªöI! NH·∫¨P T√äN & GI√Å:</b>
      <input id="in-name" type="text" placeholder="T√™n h√†ng..." />
      <input id="in-price" type="number" placeholder="Gi√°..." />
      <button class="btn-main" style="background:var(--success)" onclick="saveToCloud()">L∆ØU & TH√äM</button>
      <button onclick="cancelNew()" style="width:100%; background:none; border:none; color:gray; margin-top:10px;">H·ªßy b·ªè</button>
    </div>
    <div id="cart-list"></div>
  </div>

  <div style="height: 100px;"></div> <div class="footer-bar">
    <div class="total-flex">
      <span>T·ªîNG C·ªòNG:</span>
      <span id="bill-total">0 ‚Ç´</span>
    </div>
    <button class="btn-main" onclick="showInvoice()">XONG KH√ÅCH - IN ƒê∆†N</button>
  </div>
</div>

<div id="invoice-modal">
  <div class="inv-paper">
    <div class="inv-header">
      <h2 style="margin:0">T·∫†P HO√Å NG·∫†I H∆Ø·ªúNG</h2>
      <p id="inv-time" style="font-size:12px; margin:5px 0;"></p>
    </div>
    <table class="inv-table">
      <thead>
        <tr>
          <th style="text-align:left; width:50%;">M√≥n</th>
          <th style="text-align:center; width:15%;">SL</th>
          <th style="text-align:right; width:35%;">Ti·ªÅn</th>
        </tr>
      </thead>
      <tbody id="inv-body"></tbody>
    </table>
    <div class="inv-total">T·ªîNG: <span id="inv-total">0</span> ‚Ç´</div>
    
    <div class="no-print" style="margin-top:25px;">
      <button class="btn-main" onclick="window.print()" style="background:#444; margin-bottom:10px;">üñ®Ô∏è IN H√ìA ƒê∆†N</button>
      <button class="btn-main" onclick="closeAndReset()" style="background:var(--primary)">XONG - TI·∫æP T·ª§C QU√âT</button>
    </div>
  </div>
</div>

<script>
// THAY LINK API C·ª¶A B·∫†N V√ÄO ƒê√ÇY
const API_URL = "https://sheetdb.io/api/v1/t1ar7qsc5fvzy"; 

let globalProds = {};
let cart = [];
let scanLock = false;
const codeReader = new ZXing.BrowserBarcodeReader();

// T·∫°o √¢m thanh b√≠p b√≠p
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playBeep() {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.type = "sine";
    osc.frequency.setValueAtTime(1000, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.1);
}

async function loadCloudData() {
    try {
        const res = await fetch(API_URL);
        const data = await res.json();
        data.forEach(item => {
            globalProds[item.Barcode] = { name: item.Name, price: parseInt(item.Price) };
        });
        document.getElementById("cloud-status").innerText = "‚óè ƒê√£ ƒë·ªìng b·ªô";
        document.getElementById("cloud-status").style.color = "green";
    } catch (e) {
        document.getElementById("cloud-status").innerText = "‚óè Ngo·∫°i tuy·∫øn";
        document.getElementById("cloud-status").style.color = "red";
    }
}

window.addEventListener('load', () => {
    loadCloudData();
    startCamera();
});

function startCamera() {
    codeReader.decodeFromVideoDevice(null, 'video', (result) => {
        if (result && !scanLock) {
            const code = result.text;
            playBeep();
            scanLock = true;

            if (globalProds[code]) {
                const item = cart.find(i => i.barcode === code);
                if (item) item.qty += 1;
                else cart.push({ barcode: code, name: globalProds[code].name, price: globalProds[code].price, qty: 1 });
                updateUI();
                setTimeout(() => { scanLock = false; }, 1200); // TƒÉng ƒë·ªô nh·∫°y (ngh·ªâ 1.2s thay v√¨ 1.5s)
            } else {
                window.activeBarcode = code;
                document.getElementById("new-product-area").style.display = "block";
                document.getElementById("in-name").focus();
            }
        }
    });
}

async function saveToCloud() {
    const name = document.getElementById("in-name").value;
    const price = document.getElementById("in-price").value;
    if(!name || !price) return;

    try {
        await fetch(API_URL, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ data: [{ Barcode: window.activeBarcode, Name: name, Price: price }] })
        });
        globalProds[window.activeBarcode] = { name, price: parseInt(price) };
        cart.push({ barcode: window.activeBarcode, name, price: parseInt(price), qty: 1 });
        updateUI();
        cancelNew();
    } catch (e) { alert("L·ªói l∆∞u Cloud!"); }
}

function cancelNew() {
    document.getElementById("new-product-area").style.display = "none";
    document.getElementById("in-name").value = "";
    document.getElementById("in-price").value = "";
    scanLock = false;
}

function changeQty(idx, amt) {
    cart[idx].qty += amt;
    if (cart[idx].qty <= 0) cart.splice(idx, 1);
    updateUI();
}

function updateUI() {
    const list = document.getElementById("cart-list");
    let total = 0;
    list.innerHTML = cart.map((item, i) => {
        const sub = item.price * item.qty;
        total += sub;
        return `
        <div class="item-row">
            <div class="item-info">
                <span class="item-name">${item.name}</span>
                <span class="item-price">${item.price.toLocaleString()}‚Ç´</span>
            </div>
            <div class="qty-control">
                <button class="btn-qty" onclick="changeQty(${i}, -1)">-</button>
                <span class="qty-num">${item.qty}</span>
                <button class="btn-qty" onclick="changeQty(${i}, 1)">+</button>
            </div>
            <div style="font-weight:bold; width:80px; text-align:right">${sub.toLocaleString()}‚Ç´</div>
        </div>`;
    }).join('');
    document.getElementById("bill-total").innerText = total.toLocaleString() + " ‚Ç´";
}

function showInvoice() {
    if (cart.length === 0) return;
    scanLock = true;
    document.getElementById("inv-time").innerText = new Date().toLocaleString('vi-VN');
    let total = 0;
    document.getElementById("inv-body").innerHTML = cart.map(item => {
        const sub = item.price * item.qty;
        total += sub;
        return `<tr>
            <td>${item.name}</td>
            <td style="text-align:center">${item.qty}</td>
            <td style="text-align:right">${sub.toLocaleString()}</td>
        </tr>`;
    }).join('');
    document.getElementById("inv-total").innerText = total.toLocaleString();
    document.getElementById("invoice-modal").style.display = "block";
}

function closeAndReset() {
    cart = []; updateUI();
    document.getElementById("invoice-modal").style.display = "none";
    scanLock = false;
}
</script>
</body>
</html>
