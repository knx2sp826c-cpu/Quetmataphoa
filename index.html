<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Smart Pos - Qu·∫£n L√Ω B√°n H√†ng</title>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<style>
  :root {
    --primary: #2563eb;
    --secondary: #64748b;
    --success: #22c55e;
    --danger: #ef4444;
    --warning: #f59e0b;
    --bg: #f8fafc;
    --card: #ffffff;
    --text: #1e293b;
  }

  body { 
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
    background-color: var(--bg); 
    color: var(--text);
    margin: 0; padding: 10px;
    line-height: 1.5;
  }

  .header { text-align: center; padding: 15px 0; }
  .header h2 { margin: 0; color: var(--primary); font-size: 24px; text-transform: uppercase; letter-spacing: 1px; }
  
  .card { 
    background: var(--card); 
    padding: 18px; 
    border-radius: 16px; 
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); 
    margin-bottom: 15px;
  }

  label { font-size: 13px; font-weight: 600; color: var(--secondary); margin-bottom: 4px; display: block; }
  
  input { 
    width: 100%; font-size: 16px; padding: 12px; margin-bottom: 12px; 
    border: 1px solid #e2e8f0; border-radius: 10px; box-sizing: border-box;
    transition: all 0.2s; background: #fdfdfd;
  }
  input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

  .button-group { display: grid; grid-template-columns: 1fr; gap: 10px; }
  
  button { 
    width: 100%; font-size: 15px; padding: 14px; border: none; border-radius: 12px; 
    font-weight: 700; cursor: pointer; transition: opacity 0.2s;
    display: flex; align-items: center; justify-content: center; gap: 8px;
  }
  button:active { opacity: 0.8; transform: scale(0.98); }

  .btn-scan { background: var(--primary); color: white; }
  .btn-add { background: var(--success); color: white; }
  .btn-finish { background: var(--warning); color: white; margin-top: 15px; font-size: 17px; }

  /* Gi·ªè h√†ng */
  .cart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 8px; }
  .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
  .item-info b { font-size: 16px; display: block; }
  .item-info small { color: var(--secondary); font-size: 13px; }

  .qty-box { display: flex; align-items: center; gap: 12px; background: #f1f5f9; padding: 4px 10px; border-radius: 20px; }
  .btn-qty { width: 28px; height: 28px; background: white; border-radius: 50%; border: 1px solid #e2e8f0; font-size: 18px; padding: 0; color: var(--primary); }

  .total-section { margin-top: 20px; padding-top: 15px; border-top: 2px dashed #e2e8f0; }
  .total-row { display: flex; justify-content: space-between; align-items: center; font-size: 22px; font-weight: 800; color: var(--danger); }

  video { width: 100%; border-radius: 14px; display: none; margin-bottom: 15px; border: 3px solid var(--primary); }

  /* L·ªãch s·ª≠ */
  .history-list { max-height: 200px; overflow-y: auto; }
  .history-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #e2e8f0; font-size: 14px; }
</style>
</head>
<body>

<div class="header">
  <h2>üöÄ SMART POS</h2>
</div>

<div class="card">
  <video id="v-camera" playsinline webkit-playsinline></video>
  <button class="btn-scan" onclick="invokeScanner()">
    <span>üì∑</span> QU√âT M√É S·∫¢N PH·∫®M
  </button>
  
  <div style="margin-top: 15px;">
    <label>T√äN S·∫¢N PH·∫®M</label>
    <input id="in-name" type="text" placeholder="Nh·∫≠p t√™n ho·∫∑c qu√©t m√£..." />
    
    <div style="display: flex; gap: 10px;">
      <div style="flex: 2;">
        <label>GI√Å B√ÅN (‚Ç´)</label>
        <input id="in-price" type="number" placeholder="0" />
      </div>
      <div style="flex: 1;">
        <label>S·ªê L∆Ø·ª¢NG</label>
        <input id="in-qty" type="number" value="1" />
      </div>
    </div>
  </div>
  
  <button class="btn-add" onclick="handleAddItem()">
    <span>‚ûï</span> TH√äM V√ÄO GI·ªé H√ÄNG
  </button>
</div>

<div class="card">
  <div class="cart-header">
    <span style="font-weight: 800; font-size: 18px;">üõí GI·ªé H√ÄNG</span>
    <span id="items-count" style="background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">0 m√≥n</span>
  </div>
  
  <div id="display-list">
    <div style="text-align: center; color: var(--secondary); padding: 20px;">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o</div>
  </div>

  <div class="total-section">
    <div class="total-row">
      <span>T·ªîNG C·ªòNG:</span>
      <span id="display-total">0 ‚Ç´</span>
    </div>
    <button class="btn-finish" onclick="handleFinishBill()">
      <span>üí∞</span> THANH TO√ÅN & IN ƒê∆†N
    </button>
  </div>
</div>

<div class="card">
  <div class="cart-header">
    <span style="font-weight: 800; font-size: 16px;">üìä DOANH THU H√îM NAY</span>
  </div>
  <div id="display-history" class="history-list"></div>
</div>

<script>
// Logic gi·ªØ nguy√™n t·ª´ b·∫£n V3 ·ªïn ƒë·ªãnh nh·∫•t nh∆∞ng c·∫≠p nh·∫≠t UI render
let globalProducts = JSON.parse(localStorage.getItem("myProducts") || "{}");
let globalBills = JSON.parse(localStorage.getItem("myBills") || "{}");
let currentBill = [];
let lastScannedCode = null;

const dateStr = new Date().toLocaleDateString("vi-VN");
if (!globalBills[dateStr]) globalBills[dateStr] = [];

function invokeScanner() {
  const v = document.getElementById("v-camera");
  v.style.display = "block";
  const codeReader = new ZXing.BrowserBarcodeReader();
  codeReader.decodeFromVideoDevice(null, "v-camera", (result) => {
    if (result) {
      codeReader.reset();
      v.style.display = "none";
      lastScannedCode = result.text;
      
      if (globalProducts[lastScannedCode]) {
        document.getElementById("in-name").value = globalProducts[lastScannedCode].name;
        document.getElementById("in-price").value = globalProducts[lastScannedCode].price;
      } else {
        document.getElementById("in-name").value = "";
        document.getElementById("in-price").value = "";
        alert("M√£ v·∫°ch m·ªõi: " + lastScannedCode);
      }
    }
  });
}

function handleAddItem() {
  const elName = document.getElementById("in-name");
  const elPrice = document.getElementById("in-price");
  const elQty = document.getElementById("in-qty");

  const nameVal = elName.value.trim();
  const priceVal = parseInt(elPrice.value);
  const qtyVal = parseInt(elQty.value);

  if (!nameVal || isNaN(priceVal) || qtyVal <= 0) {
    alert("Vui l√≤ng ƒëi·ªÅn th√¥ng tin s·∫£n ph·∫©m!");
    return;
  }

  if (lastScannedCode) {
    globalProducts[lastScannedCode] = { name: nameVal, price: priceVal };
    localStorage.setItem("myProducts", JSON.stringify(globalProducts));
  }

  const existing = currentBill.find(i => i.name === nameVal && i.price === priceVal);
  if (existing) { existing.qty += qtyVal; } 
  else { currentBill.push({ name: nameVal, price: priceVal, qty: qtyVal }); }

  elName.value = ""; elPrice.value = ""; elQty.value = "1";
  lastScannedCode = null;
  updateUI();
}

function changeQty(idx, amt) {
  currentBill[idx].qty += amt;
  if (currentBill[idx].qty <= 0) currentBill.splice(idx, 1);
  updateUI();
}

function updateUI() {
  const listEl = document.getElementById("display-list");
  let totalSum = 0;
  let html = "";

  currentBill.forEach((item, i) => {
    const sub = item.price * item.qty;
    totalSum += sub;
    html += `
      <div class="item-row">
        <div class="item-info">
          <b>${item.name}</b>
          <small>${item.price.toLocaleString()} ‚Ç´ x ${item.qty}</small>
        </div>
        <div class="qty-box">
          <button class="btn-qty" onclick="changeQty(${i}, -1)">-</button>
          <span style="font-weight:bold">${item.qty}</span>
          <button class="btn-qty" onclick="changeQty(${i}, 1)">+</button>
        </div>
        <div style="font-weight:700; color:var(--primary)">${sub.toLocaleString()}‚Ç´</div>
      </div>`;
  });

  listEl.innerHTML = html || '<div style="text-align: center; color: var(--secondary); padding: 20px;">Gi·ªè h√†ng tr·ªëng</div>';
  document.getElementById("display-total").innerText = totalSum.toLocaleString() + " ‚Ç´";
  document.getElementById("items-count").innerText = currentBill.length + " m√≥n";
}

function handleFinishBill() {
  if (currentBill.length === 0) return;
  const total = currentBill.reduce((sum, i) => sum + (i.price * i.qty), 0);
  globalBills[dateStr].push({ time: new Date().toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'}), total: total });
  localStorage.setItem("myBills", JSON.stringify(globalBills));
  currentBill = [];
  updateUI();
  renderHistory();
  alert("Thanh to√°n th√†nh c√¥ng!");
}

function renderHistory() {
  const hEl = document.getElementById("display-history");
  let html = "";
  if (globalBills[dateStr]) {
    globalBills[dateStr].slice().reverse().forEach(b => {
      html += `<div class="history-item"><span>üïí ${b.time}</span><b>${b.total.toLocaleString()} ‚Ç´</b></div>`;
    });
  }
  hEl.innerHTML = html || "Ch∆∞a c√≥ ƒë∆°n h√†ng.";
}

renderHistory();
</script>
</body>
</html>
