<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>T·∫°p Ho√° Ng·∫°i H∆∞·ªùng - Pro</title>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<style>
  :root { --primary: #007aff; --success: #34c759; --danger: #ff3b30; --bg: #f2f2f7; }
  body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; overflow-x: hidden; }
  
  /* Ti√™u ƒë·ªÅ v√† Tr·∫°ng th√°i */
  .header { text-align: center; background: white; padding: 10px; border-radius: 12px; margin-bottom: 8px; position: relative; }
  .sync-status { position: absolute; top: 5px; right: 10px; font-size: 10px; font-weight: bold; }

  /* Camera */
  #camera-box { width: 100%; height: 160px; background: #000; border-radius: 12px; overflow: hidden; margin-bottom: 8px; border: 2px solid var(--primary); }
  video { width: 100%; height: 100%; object-fit: cover; }

  .card { background: white; padding: 12px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 8px; }
  
  /* Khu v·ª±c nh·∫≠p h√†ng m·ªõi */
  #new-product-area { display: none; background: #fff9c4; padding: 12px; border-radius: 10px; margin-bottom: 10px; border: 2px solid #fbc02d; }
  input { width: 100%; font-size: 18px; padding: 12px; margin: 5px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
  
  /* Danh s√°ch gi·ªè h√†ng */
  .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
  .item-name { font-size: 18px; font-weight: bold; display: block; }
  .qty-control { display: flex; align-items: center; gap: 12px; }
  .btn-qty { width: 40px; height: 40px; background: #eee; border: none; border-radius: 10px; font-size: 20px; color: var(--primary); }
  .qty-num { font-size: 24px; font-weight: bold; min-width: 25px; text-align: center; }

  /* THANH ƒêI·ªÄU KHI·ªÇN - ƒê∆ØA L√äN CAO THEO Y√äU C·∫¶U */
  .footer-bar { 
    position: fixed; 
    bottom: 100px; /* C√°ch ƒë√°y 100px ƒë·ªÉ kh√¥ng v∆∞·ªõng iPhone */
    left: 10px; 
    right: 10px; 
    background: white; 
    padding: 15px; 
    border-radius: 20px; 
    box-shadow: 0 -10px 25px rgba(0,0,0,0.15); 
    z-index: 1000;
  }
  .total-flex { display: flex; justify-content: space-between; font-size: 22px; font-weight: 900; color: var(--danger); margin-bottom: 12px; }
  .btn-main { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 12px; font-size: 18px; font-weight: bold; width: 100%; margin-bottom: 8px; }
  .btn-history { background: #5856d6; }

  /* Giao di·ªán H√≥a ƒë∆°n & L·ªãch s·ª≠ */
  .full-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; padding: 20px; box-sizing: border-box; overflow-y: auto; }
  .inv-paper { max-width: 350px; margin: 0 auto; color: #000; font-family: monospace; }
  .inv-header { text-align: center; border-bottom: 1px dashed #000; padding-bottom: 10px; }
  .inv-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  .inv-table th { border-bottom: 1px solid #000; padding: 5px 0; }
  .inv-total { border-top: 2px double #000; margin-top: 10px; padding-top: 8px; font-size: 22px; font-weight: bold; text-align: right; }
  
  .history-item { border-bottom: 1px solid #ddd; padding: 12px 0; display: flex; justify-content: space-between; }

  @media print { .no-print { display: none !important; } .full-modal { position: relative; padding: 0; } }
</style>
</head>
<body>

<div class="no-print">
  <div class="header">
    <span id="cloud-status" class="sync-status">‚óè ƒêang k·∫øt n·ªëi...</span>
    <h1 style="margin:0; font-size:20px; color:#d70119;">T·∫†P HO√Å NG·∫†I H∆Ø·ªúNG</h1>
  </div>
  
  <div id="camera-box"><video id="video" playsinline></video></div>
  
  <div class="card">
    <div id="new-product-area">
      <b style="color:red">S·∫¢N PH·∫®M M·ªöI / C·∫¨P NH·∫¨T:</b>
      <input id="in-name" type="text" placeholder="T√™n s·∫£n ph·∫©m..." />
      <input id="in-price" type="number" placeholder="Gi√° b√°n..." />
      <button class="btn-main" style="background:var(--success)" onclick="saveToCloud()">L∆ØU H·ªÜ TH·ªêNG</button>
      <button onclick="cancelNew()" style="width:100%; background:none; border:none; color:gray; margin-top:10px;">H·ªßy b·ªè</button>
    </div>
    <div id="cart-list"></div>
  </div>

  <div style="height: 250px;"></div>

  <div class="footer-bar">
    <div class="total-flex"><span>T·ªîNG:</span><span id="bill-total">0 ‚Ç´</span></div>
    <button class="btn-main" onclick="showInvoice()">XONG KH√ÅCH - IN ƒê∆†N</button>
    <button class="btn-main btn-history" onclick="showHistory()">XEM DOANH THU</button>
  </div>
</div>

<div id="invoice-modal" class="full-modal">
  <div class="inv-paper">
    <div class="inv-header"><h2>T·∫†P HO√Å NG·∫†I H∆Ø·ªúNG</h2><p id="inv-time"></p></div>
    <table class="inv-table">
        <thead><tr><th align="left">M√≥n</th><th align="center">SL</th><th align="right">Ti·ªÅn</th></tr></thead>
        <tbody id="inv-body"></tbody>
    </table>
    <div class="inv-total">T·ªîNG: <span id="inv-total">0</span> ‚Ç´</div>
    <div class="no-print" style="margin-top:30px;">
      <button class="btn-main" onclick="printAndSaveCloud()" style="background:#444;">üñ®Ô∏è IN & L∆ØU DOANH THU</button>
      <button class="btn-main" onclick="closeAndReset()" style="background:var(--primary); margin-top:10px;">TI·∫æP T·ª§C QU√âT</button>
    </div>
  </div>
</div>

<div id="history-modal" class="full-modal">
  <h2 style="text-align:center">L·ªäCH S·ª¨ B√ÅN H√ÄNG</h2>
  <div id="history-content"></div>
  <button class="btn-main" style="margin-top:20px" onclick="document.getElementById('history-modal').style.display='none'">QUAY L·∫†I</button>
</div>

<script>
// LINK API ƒê√É S·ª¨A L·ªñI EX·∫æC -> EXEC
const API_URL = "https://script.google.com/macros/s/AKfycbyvELWXInZ2G3G5iBrM9HaiU10L2q6hlTNT3u8_xropYBW80VbENHObpSavUB4WOGVz/exec"; 

let globalProds = {};
let cart = [];
let scanLock = false;
const codeReader = new ZXing.BrowserBarcodeReader();
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playBeep() {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.frequency.setValueAtTime(1000, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
    osc.start(); osc.stop(audioCtx.currentTime + 0.1);
}

async function loadCloudData() {
    try {
        const res = await fetch(API_URL);
        const data = await res.json();
        globalProds = {};
        data.forEach(item => { globalProds[item.Barcode] = { name: item.Name, price: parseInt(item.Price) }; });
        document.getElementById("cloud-status").innerText = "‚óè ƒê√£ ƒë·ªìng b·ªô (" + data.length + " m√≥n)";
        document.getElementById("cloud-status").style.color = "green";
    } catch (e) { 
        document.getElementById("cloud-status").innerText = "‚óè Ngo·∫°i tuy·∫øn"; 
        document.getElementById("cloud-status").style.color = "red"; 
    }
}

window.addEventListener('load', () => { loadCloudData(); startCamera(); });

function startCamera() {
    codeReader.decodeFromVideoDevice(null, 'video', (result) => {
        if (result && !scanLock) {
            const code = result.text;
            playBeep();
            scanLock = true;
            if (globalProds[code]) {
                const existing = cart.find(i => i.barcode === code);
                if (existing) existing.qty += 1;
                else cart.push({ barcode: code, name: globalProds[code].name, price: globalProds[code].price, qty: 1 });
                updateUI();
                setTimeout(() => { scanLock = false; }, 1000);
            } else {
                window.activeBarcode = code;
                document.getElementById("new-product-area").style.display = "block";
                document.getElementById("in-name").focus();
            }
        }
    });
}

async function saveToCloud() {
    const name = document.getElementById("in-name").value;
    const price = document.getElementById("in-price").value;
    if(!name || !price) return;
    
    document.getElementById("cloud-status").innerText = "‚óè ƒêang l∆∞u...";
    try {
        await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({ data: [{ Barcode: window.activeBarcode, Name: name, Price: price }] })
        });
        globalProds[window.activeBarcode] = { name, price: parseInt(price) };
        if (!cart.find(i => i.barcode === window.activeBarcode)) {
            cart.push({ barcode: window.activeBarcode, name, price: parseInt(price), qty: 1 });
        }
        updateUI();
        cancelNew();
        loadCloudData();
    } catch (e) { alert("L·ªói l∆∞u Cloud!"); }
}

function cancelNew() { document.getElementById("new-product-area").style.display = "none"; scanLock = false; }
function changeQty(idx, amt) { cart[idx].qty += amt; if (cart[idx].qty <= 0) cart.splice(idx, 1); updateUI(); }

function updateUI() {
    const list = document.getElementById("cart-list");
    let total = 0;
    list.innerHTML = cart.map((item, i) => {
        const sub = item.price * item.qty; total += sub;
        return `<div class="item-row">
            <div style="flex:1"><span class="item-name">${item.name}</span><span>${item.price.toLocaleString()}ƒë</span></div>
            <div class="qty-control">
                <button class="btn-qty" onclick="changeQty(${i}, -1)">-</button>
                <span class="qty-num">${item.qty}</span>
                <button class="btn-qty" onclick="changeQty(${i}, 1)">+</button>
            </div>
            <div style="width:80px; text-align:right; font-weight:bold;">${sub.toLocaleString()}ƒë</div>
        </div>`;
    }).join('');
    document.getElementById("bill-total").innerText = total.toLocaleString() + " ‚Ç´";
}

function showInvoice() {
    if (cart.length === 0) return;
    scanLock = true;
    const now = new Date();
    document.getElementById("inv-time").innerText = now.toLocaleString('vi-VN');
    let total = 0;
    document.getElementById("inv-body").innerHTML = cart.map(item => {
        const sub = item.price * item.qty; total += sub;
        return `<tr><td>${item.name}</td><td align="center">${item.qty}</td><td align="right">${sub.toLocaleString()}</td></tr>`;
    }).join('');
    document.getElementById("inv-total").innerText = total.toLocaleString();
    document.getElementById("invoice-modal").style.display = "block";
}

async function printAndSaveCloud() {
    const total = document.getElementById("inv-total").innerText;
    const time = document.getElementById("inv-time").innerText;
    
    // L∆∞u v√†o b·ªô nh·ªõ m√°y (ƒë·ªÉ xem nhanh)
    let history = JSON.parse(localStorage.getItem('sale_history') || '[]');
    history.unshift({ time, total });
    localStorage.setItem('sale_history', JSON.stringify(history));

    // G·ª≠i doanh thu l√™n Google Sheet (Trang t√≠nh 2)
    try {
        fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({ type: "history", time: time, total: total })
        });
    } catch (e) {}

    window.print();
}

function showHistory() {
    const history = JSON.parse(localStorage.getItem('sale_history') || '[]');
    let html = history.length ? "" : "<p align='center'>Ch∆∞a c√≥ d·ªØ li·ªáu h√¥m nay.</p>";
    let daySum = 0;
    history.forEach(item => {
        html += `<div class="history-item"><span>${item.time}</span><b>${item.total} ‚Ç´</b></div>`;
        daySum += parseInt(item.total.replace(/\./g, ''));
    });
    document.getElementById("history-content").innerHTML = 
        `<div class="card" style="background:#f2f2f7; text-align:center"><h3>T·ªîNG DOANH THU: ${daySum.toLocaleString()} ‚Ç´</h3></div>` + html;
    document.getElementById("history-modal").style.display = "block";
}

function closeAndReset() { cart = []; updateUI(); document.getElementById("invoice-modal").style.display = "none"; scanLock = false; }
</script>
</body>
</html>
