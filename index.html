<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>T·∫°p Ho√° Ng·∫°i H∆∞·ªùng</title>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        :root { --primary: #d70119; --success: #34c759; --danger: #ff3b30; --bg: #f2f2f7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; padding-bottom: 200px; -webkit-tap-highlight-color: transparent; }
        .rainbow-text { font-weight: 900; background-image: linear-gradient(to left, violet, indigo, blue, green, orange, red); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header { background: white; padding: 15px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        #status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ff9500; display: inline-block; margin-right: 5px; }
        
        #camera-box { width: 100%; height: 180px; background: #000; border-radius: 20px; overflow: hidden; border: 3px solid #007aff; margin-top: 10px; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        .card { background: white; padding: 15px; border-radius: 15px; margin-top: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; text-transform: uppercase; margin-top: 8px; }
        .btn-blue { background: #1a73e8; color: white; }
        .btn-purple { background: #5856d6; color: white; }
        .btn-black { background: #333; color: white; }

        /* PH·∫¶N CH·ªàNH GI·ªé H√ÄNG TO 150% V√Ä N√öT B·∫§M */
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #eee; font-size: 24px; } 
        .qty-controls { display: flex; align-items: center; gap: 15px; }
        .btn-qty { width: 45px; height: 45px; border-radius: 10px; border: 1px solid #007aff; background: #fff; font-size: 26px; font-weight: bold; color: #007aff; display: flex; justify-content: center; align-items: center; }

        .footer { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; border-radius: 25px 25px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 100; }
        
        #bill-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .bill-header { text-align: center; margin-bottom: 20px; }
        .bill-title { font-size: 24px; font-weight: bold; margin: 0; }
        .bill-time { font-size: 14px; color: #666; margin-top: 5px; }
        .bill-divider { border-top: 1px dashed #333; margin: 15px 0; }
        .bill-table { width: 100%; border-collapse: collapse; }
        .bill-table th { border-bottom: 1px solid #333; padding: 10px 0; font-size: 15px; }
        .bill-table td { padding: 12px 0; font-size: 18px; border-bottom: 1px solid #eee; }
        .total-row { display: flex; justify-content: flex-end; align-items: center; font-size: 24px; font-weight: bold; padding: 20px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h2 class="rainbow-text" style="margin:0;">T·∫†P HO√Å NG·∫†I H∆Ø·ªúNG</h2>
        <div style="display:flex; align-items:center; font-size:12px;"><span id="status-dot"></span><span id="status-text">ƒêang n·ªëi...</span></div>
    </div>

    <div id="camera-box"><video id="video" playsinline></video></div>

    <div id="new-product-area" class="card" style="display:none; border: 2px solid #fbc02d;">
        <b>M√ìN M·ªöI CH∆ØA C√ì:</b>
        <input id="in-name" style="width:100%; padding:12px; margin:5px 0; border-radius:8px; border:1px solid #ddd;" type="text" placeholder="T√™n h√†ng">
        <input id="in-price" style="width:100%; padding:12px; margin:5px 0; border-radius:8px; border:1px solid #ddd;" type="number" placeholder="Gi√° b√°n">
        <button class="btn" style="background:var(--success); color:white" onclick="saveToCloud()">L∆ØU V√ÄO H·ªÜ TH·ªêNG</button>
    </div>

    <div class="card">
        <b style="color:#555">GI·ªé H√ÄNG:</b>
        <div id="cart-list" style="margin-top:10px;"><p style="text-align:center; color:#999; font-size: 20px;">Ch∆∞a c√≥ h√†ng</p></div>
    </div>

    <div id="bill-overlay">
        <div class="bill-header">
            <p class="bill-title">T·∫†P HO√Å NG·∫†I H∆Ø·ªúNG</p>
            <p id="bill-time-val" class="bill-time"></p>
        </div>
        <div class="bill-divider"></div>
        <table class="bill-table">
            <thead><tr><th align="left">M√≥n</th><th align="center">SL</th><th align="right">Ti·ªÅn</th></tr></thead>
            <tbody id="bill-items-body"></tbody>
        </table>
        <div class="bill-divider"></div>
        <div class="total-row">T·ªîNG: <span id="bill-total-final" style="margin-left:10px; color:red;">0 ‚Ç´</span></div>
        <button class="btn btn-black" onclick="window.print()">üñ®Ô∏è IN H√ìA ƒê∆†N</button>
        <button class="btn btn-blue" onclick="closeBill()">XONG - TI·∫æP T·ª§C QU√âT</button>
    </div>

    <div class="footer">
        <div style="display:flex; justify-content:space-between; font-size:24px; font-weight:bold; color:var(--danger); margin-bottom:10px;">
            <span>T·ªîNG C·ªòNG:</span><span id="bill-total">0 ‚Ç´</span>
        </div>
        <button class="btn btn-blue" onclick="showBill()">XONG KH√ÅCH - THANH TO√ÅN</button>
        <button class="btn btn-purple" onclick="viewHistory()">XEM L·ªäCH S·ª¨ B√ÅN H√ÄNG</button>
    </div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyvELWXInZ2G3G5iBrM9HaiU10L2q6hlTNT3u8_xropYBW80VbENHObpSavUB4WOGVz/exec";
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/1emE2-PGMZU8epGKC8FXf1FANXIRR09lqY6dPTN8ieexhDPolt9vWzT7-/edit#gid=1114532930";
    
    function playBeep() {
        try {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode); gainNode.connect(audioCtx.destination);
            oscillator.type = 'sine'; oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            oscillator.start(); oscillator.stop(audioCtx.currentTime + 0.1);
        } catch(e) {}
    }

    let globalProds = JSON.parse(localStorage.getItem('huong_ngai_cache') || "{}"), cart = [], scanLock = false;
    const hints = new Map(); hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [ZXing.BarcodeFormat.EAN_13, ZXing.BarcodeFormat.EAN_8, ZXing.BarcodeFormat.CODE_128, ZXing.BarcodeFormat.UPC_A]);
    const codeReader = new ZXing.BrowserBarcodeReader(hints);

    async function loadData() {
        try {
            const res = await fetch(API_URL); const data = await res.json();
            globalProds = {}; data.forEach(i => { if(i.Barcode) globalProds[i.Barcode.toString().trim()] = { name: i.Name, price: parseInt(i.Price) }; });
            localStorage.setItem('huong_ngai_cache', JSON.stringify(globalProds));
            document.getElementById("status-dot").style.background = "#34c759"; document.getElementById("status-text").innerText = "ƒê√£ ƒë·ªìng b·ªô Cloud";
        } catch (e) { document.getElementById("status-dot").style.background = "#ff3b30"; document.getElementById("status-text").innerText = "Ch·∫ø ƒë·ªô Offline"; }
    }

    function startScan() {
        const constraints = { video: { facingMode: "environment", width: { ideal: 640 }, height: { ideal: 480 } } };
        codeReader.decodeFromConstraints(constraints, 'video', (result) => {
            if (result && !scanLock) {
                const code = result.text.trim(); scanLock = true; playBeep();
                if (globalProds[code]) { addItemToCart(code); setTimeout(() => scanLock = false, 600); }
                else { window.activeBarcode = code; document.getElementById("new-product-area").style.display = "block"; }
            }
        });
    }

    function addItemToCart(code) {
        let item = cart.find(i => i.barcode === code);
        if (item) item.qty++; else cart.push({ barcode: code, name: globalProds[code].name, price: globalProds[code].price, qty: 1 });
        updateUI();
    }

    // H√ÄM TƒÇNG GI·∫¢M S·ªê L∆Ø·ª¢NG
    function changeQty(index, delta) {
        cart[index].qty += delta;
        if (cart[index].qty <= 0) cart.splice(index, 1);
        updateUI();
    }

    function updateUI() {
        const list = document.getElementById("cart-list");
        if (cart.length === 0) { list.innerHTML = `<p style="text-align:center; color:#999; font-size: 20px;">Ch∆∞a c√≥ h√†ng</p>`; document.getElementById("bill-total").innerText = "0 ‚Ç´"; return; }
        let total = 0;
        list.innerHTML = cart.map((item, index) => {
            total += item.price * item.qty;
            return `<div class="cart-item">
                <div style="flex:1"><b>${item.name}</b><br><small style="font-size: 16px; color: #666;">${item.price.toLocaleString()}ƒë</small></div>
                <div class="qty-controls">
                    <button class="btn-qty" onclick="changeQty(${index}, -1)">-</button>
                    <b style="min-width: 25px; text-align:center;">${item.qty}</b>
                    <button class="btn-qty" onclick="changeQty(${index}, 1)">+</button>
                </div>
                <div style="min-width: 110px; text-align: right; font-weight: bold;">${(item.price * item.qty).toLocaleString()}ƒë</div>
            </div>`;
        }).join('');
        document.getElementById("bill-total").innerText = total.toLocaleString() + " ‚Ç´";
    }

    function showBill() {
        if (cart.length === 0) return;
        const now = new Date();
        const timeStr = now.toLocaleTimeString('vi-VN') + " " + now.toLocaleDateString('vi-VN');
        const totalVal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
        document.getElementById("bill-time-val").innerText = timeStr;
        document.getElementById("bill-items-body").innerHTML = cart.map(item => 
            `<tr><td>${item.name}</td><td align="center">${item.qty}</td><td align="right">${(item.price * item.qty).toLocaleString()}</td></tr>`
        ).join('');
        document.getElementById("bill-total-final").innerText = totalVal.toLocaleString() + " ƒë";
        document.getElementById("bill-overlay").style.display = "block";
        fetch(API_URL, { method: 'POST', body: JSON.stringify({ type: "history", time: timeStr, total: Number(totalVal) }) });
    }

    function closeBill() { document.getElementById("bill-overlay").style.display = "none"; cart = []; updateUI(); scanLock = false; }
    function viewHistory() { window.open(SHEET_URL, '_blank'); }

    async function saveToCloud() {
        const n = document.getElementById("in-name").value, p = document.getElementById("in-price").value;
        if(!n || !p) return;
        globalProds[window.activeBarcode] = { name: n, price: parseInt(p) };
        addItemToCart(window.activeBarcode);
        document.getElementById("new-product-area").style.display = "none";
        document.getElementById("in-name").value = ""; document.getElementById("in-price").value = "";
        fetch(API_URL, { method: 'POST', body: JSON.stringify({ data: [{ Barcode: window.activeBarcode, Name: n, Price: p }] }) });
        setTimeout(() => scanLock = false, 600);
    }

    window.onload = () => { loadData(); startScan(); };
</script>
</body>
</html>
