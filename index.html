<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>T·∫°p Ho√° Ng·∫°i H∆∞·ªùng - POS</title>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<style>
  :root { --primary: #007aff; --success: #34c759; --danger: #ff3b30; --bg: #f2f2f7; }
  body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; padding-bottom: 120px; }
  
  .header { text-align: center; background: white; padding: 15px; border-radius: 15px; margin-bottom: 10px; }
  .header h1 { margin: 0; color: #d70119; font-size: 24px; }

  #camera-box { width: 100%; height: 180px; background: #000; border-radius: 15px; overflow: hidden; position: relative; margin-bottom: 10px; border: 3px solid var(--primary); }
  video { width: 100%; height: 100%; object-fit: cover; }

  .card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 10px; }
  
  /* √î nh·∫≠p h√†ng m·ªõi */
  #new-product-area { display: none; background: #fff9c4; padding: 10px; border-radius: 10px; margin-bottom: 10px; border: 2px solid var(--warning); }
  input { width: 100%; font-size: 18px; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
  
  /* Gi·ªè h√†ng */
  .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
  .item-name { flex: 1; font-size: 18px; font-weight: bold; }
  .qty-control { display: flex; align-items: center; gap: 10px; }
  .btn-qty { width: 45px; height: 45px; background: #eee; border: none; border-radius: 10px; font-size: 25px; font-weight: bold; color: var(--primary); }
  .qty-num { font-size: 28px; font-weight: 800; min-width: 35px; text-align: center; }

  /* Thanh t·ªïng ti·ªÅn c·ªë ƒë·ªãnh */
  .footer-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; border-top: 1px solid #ddd; z-index: 100; }
  .total-flex { display: flex; justify-content: space-between; font-size: 22px; font-weight: 900; color: var(--danger); margin-bottom: 10px; }
  .btn-main { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 12px; font-size: 18px; font-weight: bold; width: 100%; }

  /* Modal H√≥a ƒë∆°n chi ti·∫øt */
  #invoice-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto; }
  .invoice-paper { background: white; width: 90%; margin: 30px auto; padding: 20px; border-radius: 5px; font-family: 'Courier New', Courier, monospace; }
  .invoice-header { text-align: center; border-bottom: 1px dashed #000; padding-bottom: 10px; margin-bottom: 10px; }
  .invoice-table { width: 100%; border-collapse: collapse; }
  .invoice-table th { text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
  .invoice-table td { padding: 8px 0; font-size: 14px; }
  .invoice-total { border-top: 2px double #000; margin-top: 10px; padding-top: 10px; font-size: 18px; font-weight: bold; text-align: right; }
</style>
</head>
<body>

<div class="header">
  <h1>üè™ T·∫†P HO√Å NG·∫†I H∆Ø·ªúNG</h1>
</div>

<div id="camera-box">
  <video id="video" playsinline></video>
</div>

<div class="card">
  <div id="new-product-area">
    <b style="color:red">M√É M·ªöI! NH·∫¨P T√äN & GI√Å:</b>
    <input id="in-name" type="text" placeholder="T√™n s·∫£n ph·∫©m..." />
    <input id="in-price" type="number" placeholder="Gi√° b√°n..." />
    <button class="btn-main" style="background:var(--success)" onclick="saveAndAdd()">L∆ØU V√ÄO M√ÅY</button>
  </div>

  <div id="cart-list">
    <p style="text-align: center; color: #999;">Ch∆∞a c√≥ h√†ng trong gi·ªè...</p>
  </div>
</div>

<div class="footer-bar">
  <div class="total-flex">
    <span>T·ªîNG C·ªòNG:</span>
    <span id="bill-total">0 ‚Ç´</span>
  </div>
  <button class="btn-main" onclick="showInvoice()">‚úÖ XONG KH√ÅCH - IN ƒê∆†N</button>
</div>

<div id="invoice-modal">
  <div class="invoice-paper">
    <div class="invoice-header">
      <h2 style="margin:0">T·∫†P HO√Å NG·∫†I H∆Ø·ªúNG</h2>
      <p style="font-size:12px" id="inv-time"></p>
      <p style="margin:5px 0">-------------------------</p>
      <h3 style="margin:5px 0">HO√Å ƒê∆†N THANH TO√ÅN</h3>
    </div>
    <table class="invoice-table">
      <thead>
        <tr>
          <th>M√≥n</th>
          <th style="text-align:center">SL</th>
          <th style="text-align:right">T.Ti·ªÅn</th>
        </tr>
      </thead>
      <tbody id="inv-body"></tbody>
    </table>
    <div class="invoice-total">T·ªîNG: <span id="inv-total">0</span> ‚Ç´</div>
    <p style="text-align:center; margin-top:20px; font-size:12px">C·∫£m ∆°n Qu√Ω kh√°ch! H·∫πn g·∫∑p l·∫°i.</p>
    <button class="btn-main" onclick="closeAndReset()" style="margin-top:20px">ƒê√ìNG & TI·∫æP T·ª§C QU√âT</button>
  </div>
</div>

<script>
let globalProds = JSON.parse(localStorage.getItem("ngaiHuongProds") || "{}");
let globalBills = JSON.parse(localStorage.getItem("ngaiHuongBills") || "{}");
let cart = [];
let scanCode = null;
const codeReader = new ZXing.BrowserBarcodeReader();

// Kh·ªüi ƒë·ªông camera li√™n t·ª•c
window.addEventListener('load', () => startScan());

function startScan() {
  codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
    if (result && result.text !== scanCode) {
      scanCode = result.text;
      if (globalProds[scanCode]) {
        addToCart(globalProds[scanCode].name, globalProds[scanCode].price, scanCode);
        document.getElementById("new-product-area").style.display = "none";
      } else {
        document.getElementById("new-product-area").style.display = "block";
        document.getElementById("in-name").focus();
      }
      setTimeout(() => { scanCode = null; }, 2000); // Tr√°nh qu√©t l·∫∑p qu√° nhanh
    }
  });
}

function addToCart(name, price, barcode) {
  const item = cart.find(i => i.barcode === barcode);
  if (item) { item.qty += 1; } 
  else { cart.push({ barcode, name, price, qty: 1 }); }
  updateUI();
}

function saveAndAdd() {
  const n = document.getElementById("in-name").value;
  const p = parseInt(document.getElementById("in-price").value);
  if (!n || !p) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!");
  globalProds[scanCode] = { name: n, price: p };
  localStorage.setItem("ngaiHuongProds", JSON.stringify(globalProds));
  addToCart(n, p, scanCode);
  document.getElementById("new-product-area").style.display = "none";
  document.getElementById("in-name").value = "";
  document.getElementById("in-price").value = "";
}

function changeQty(idx, amt) {
  cart[idx].qty += amt;
  if (cart[idx].qty <= 0) cart.splice(idx, 1);
  updateUI();
}

function updateUI() {
  const list = document.getElementById("cart-list");
  let total = 0;
  let html = "";
  cart.forEach((item, i) => {
    const sub = item.price * item.qty;
    total += sub;
    html += `
      <div class="item-row">
        <div class="item-name">${item.name}<br><small>${item.price.toLocaleString()}‚Ç´</small></div>
        <div class="qty-control">
          <button class="btn-qty" onclick="changeQty(${i}, -1)">-</button>
          <span class="qty-num">${item.qty}</span>
          <button class="btn-qty" onclick="changeQty(${i}, 1)">+</button>
        </div>
        <div style="font-weight:bold; width:90px; text-align:right">${sub.toLocaleString()}‚Ç´</div>
      </div>`;
  });
  list.innerHTML = html || '<p style="text-align: center; color: #999;">Ch∆∞a c√≥ h√†ng...</p>';
  document.getElementById("bill-total").innerText = total.toLocaleString() + " ‚Ç´";
}

function showInvoice() {
  if (cart.length === 0) return;
  const now = new Date();
  document.getElementById("inv-time").innerText = now.toLocaleString('vi-VN');
  
  let invHtml = "";
  let total = 0;
  cart.forEach(item => {
    const sub = item.price * item.qty;
    total += sub;
    invHtml += `<tr>
      <td>${item.name}</td>
      <td style="text-align:center">${item.qty}</td>
      <td style="text-align:right">${sub.toLocaleString()}</td>
    </tr>`;
  });
  
  document.getElementById("inv-body").innerHTML = invHtml;
  document.getElementById("inv-total").innerText = total.toLocaleString();
  document.getElementById("invoice-modal").style.display = "block";
  
  // L∆∞u doanh thu
  const dateKey = now.toLocaleDateString("vi-VN");
  if (!globalBills[dateKey]) globalBills[dateKey] = [];
  globalBills[dateKey].push({ time: now.toLocaleTimeString(), total: total });
  localStorage.setItem("globalBills", JSON.stringify(globalBills));
}

function closeAndReset() {
  cart = [];
  updateUI();
  document.getElementById("invoice-modal").style.display = "none";
  // Kh·ªüi ƒë·ªông l·∫°i camera ƒë·ªÉ tr√°nh ƒë∆°
  codeReader.reset();
  startScan();
}
</script>
</body>
</html>
