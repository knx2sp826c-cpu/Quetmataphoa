<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>T·∫°p Ho√° Ng·∫°i H∆∞·ªùng</title>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        :root { --primary: #d70119; --success: #34c759; --danger: #ff3b30; --bg: #f2f2f7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; padding-bottom: 210px; -webkit-tap-highlight-color: transparent; }
        .rainbow-text { font-weight: 900; background-image: linear-gradient(to left, violet, indigo, blue, green, orange, red); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header { background: white; padding: 15px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        #status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ff9500; display: inline-block; margin-right: 5px; }
        
        /* Ch·ªânh s·ª≠a camera-box ƒë·ªÉ ch·ª©a n√∫t v√†ng */
        #camera-box { width: 100%; height: 180px; background: #000; border-radius: 20px; overflow: hidden; border: 3px solid #007aff; margin-top: 10px; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        .card { background: white; padding: 15px; border-radius: 15px; margin-top: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative; }
        .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; text-transform: uppercase; margin-top: 8px; }
        .btn-blue { background: #1a73e8; color: white; }
        .btn-purple { background: #5856d6; color: white; }
        .btn-black { background: #333; color: white; }
        
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #eee; font-size: 24px; } 
        .qty-controls { display: flex; align-items: center; gap: 15px; }
        .btn-qty { width: 45px; height: 45px; border-radius: 10px; border: 1px solid #007aff; background: #fff; font-size: 26px; font-weight: bold; color: #007aff; display: flex; justify-content: center; align-items: center; }

        /* ƒê∆∞a n√∫t v√†ng l√™n s√°t Camera */
        .btn-no-code { 
            position: absolute; right: 10px; bottom: 10px; 
            width: 75px; height: 75px; border-radius: 50%; 
            background: #FFD700; color: #333; border: 3px solid #fff;
            font-size: 11px; font-weight: bold; text-align: center;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 99;
            line-height: 1.2; padding: 5px; cursor: pointer;
        }

        #bill-overlay, #history-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .overlay-title { font-size: 24px; font-weight: bold; text-align: center; margin-bottom: 15px; }
        .bill-table, .history-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .bill-table th, .history-table th { border-bottom: 2px solid #333; padding: 10px 0; }
        .bill-table td, .history-table td { padding: 12px 0; border-bottom: 1px solid #eee; }

        .footer { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; border-radius: 25px 25px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 100; }

        #num-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center; }
        .modal-content { background:white; padding:20px; border-radius:15px; width:80%; max-width:300px; text-align:center; }
        .modal-input { width:100%; padding:15px; font-size:24px; border:2px solid #007aff; border-radius:10px; text-align:center; margin:15px 0; }
    </style>
</head>
<body>
    <div id="num-modal">
        <div class="modal-content">
            <b id="modal-label" style="font-size:18px;">Nh·∫≠p gi√°:</b>
            <input id="modal-field" type="number" inputmode="numeric" pattern="[0-9]*" class="modal-input">
            <div style="display:flex; gap:10px;">
                <button class="btn btn-black" style="margin:0; flex:1;" onclick="closeNumModal()">H·ª¶Y</button>
                <button class="btn btn-blue" style="margin:0; flex:1;" onclick="confirmNumModal()">OK</button>
            </div>
        </div>
    </div>

    <div class="header">
        <h2 class="rainbow-text" style="margin:0;">T·∫†P HO√Å NG·∫†I H∆Ø·ªúNG</h2>
        <div style="display:flex; align-items:center; font-size:12px;"><span id="status-dot"></span><span id="status-text">ƒêang n·ªëi...</span></div>
    </div>

    <div id="camera-box">
        <video id="video" playsinline></video>
        <div class="btn-no-code" onclick="showNoCodeInput()">M·∫∂T H√ÄNG<br>KH√îNG M√É</div>
    </div>

    <div id="new-product-area" class="card" style="display:none; border: 2px solid #fbc02d;">
        <b>M√ìN M·ªöI CH∆ØA C√ì:</b>
        <input id="in-name" style="width:100%; padding:12px; margin:5px 0; border-radius:8px; border:1px solid #ddd;" type="text" placeholder="T√™n h√†ng">
        <input id="in-price" style="width:100%; padding:12px; margin:5px 0; border-radius:8px; border:1px solid #ddd;" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="Gi√° b√°n">
        <button class="btn" style="background:var(--success); color:white" onclick="saveToCloud()">L∆ØU V√ÄO H·ªÜ TH·ªêNG</button>
    </div>

    <div class="card">
        <b style="color:#555">GI·ªé H√ÄNG:</b>
        <div id="cart-list" style="margin-top:10px;"><p style="text-align:center; color:#999; font-size: 20px;">Ch∆∞a c√≥ h√†ng</p></div>
    </div>

    <div id="history-overlay">
        <p class="overlay-title">L·ªäCH S·ª¨ B√ÅN H√ÄNG (7 NG√ÄY QUA)</p>
        <div style="background: #e1f5fe; padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: center;">
            <span style="font-size: 18px;">T·ªîNG THU H√îM NAY:</span><br>
            <b id="history-day-total" style="font-size: 28px; color: #d70119;">0 ‚Ç´</b>
        </div>
        <table class="history-table">
            <thead><tr><th align="left">Th·ªùi gian</th><th align="right">S·ªë ti·ªÅn</th></tr></thead>
            <tbody id="history-items-body"></tbody>
        </table>
        <button class="btn btn-blue" style="margin-top: 20px;" onclick="closeHistory()">ƒê√ìNG L·ªäCH S·ª¨</button>
        <button class="btn btn-black" onclick="window.open(SHEET_URL, '_blank')">M·ªû FILE EXCEL G·ªêC</button>
    </div>

    <div id="bill-overlay">
        <div class="bill-header" style="text-align:center">
            <p class="bill-title" style="font-size:24px; font-weight:bold;">T·∫†P HO√Å NG·∫†I H∆Ø·ªúNG</p>
            <p id="bill-time-val" style="color:#666;"></p>
        </div>
        <hr style="border: 1px dashed #333">
        <table class="bill-table">
            <thead><tr><th align="left">M√≥n</th><th align="center">SL</th><th align="right">Ti·ªÅn</th></tr></thead>
            <tbody id="bill-items-body"></tbody>
        </table>
        <p style="text-align:right; font-size:24px; font-weight:bold; margin-top:20px;">T·ªîNG: <span id="bill-total-final" style="color:red">0 ‚Ç´</span></p>
        <button class="btn btn-black" onclick="window.print()">üñ®Ô∏è IN H√ìA ƒê∆†N</button>
        <button class="btn btn-blue" onclick="closeBill()">XONG - TI·∫æP T·ª§C QU√âT</button>
    </div>

    <div class="footer">
        <div style="display:flex; justify-content:space-between; font-size:24px; font-weight:bold; color:var(--danger); margin-bottom:10px;">
            <span>T·ªîNG C·ªòNG:</span><span id="bill-total">0 ‚Ç´</span>
        </div>
        <button class="btn btn-blue" onclick="showBill()">XONG KH√ÅCH - THANH TO√ÅN</button>
        <button class="btn btn-purple" onclick="openHistory()">XEM L·ªäCH S·ª¨ B√ÅN H√ÄNG</button>
    </div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyvELWXInZ2G3G5iBrM9HaiU10L2q6hlTNT3u8_xropYBW80VbENHObpSavUB4WOGVz/exec";
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/1emE2-PGMZU8epGKC8FXf1FANXIRR09lqY6dPTN8ieexhDPolt9vWzT7-/edit#gid=1114532930";
    
    let globalProds = JSON.parse(localStorage.getItem('huong_ngai_cache') || "{}"), cart = [], saleHistory = [], scanLock = false;
    let noCodeCount = 0;
    let currentModalTarget = null;

    function playBeep() {
        try {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.type = 'sine'; osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        } catch(e) {}
    }

    const hints = new Map();
    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [ZXing.BarcodeFormat.EAN_13, ZXing.BarcodeFormat.EAN_8, ZXing.BarcodeFormat.CODE_128, ZXing.BarcodeFormat.UPC_A]);
    hints.set(ZXing.DecodeHintType.TRY_HARDER, false);
    const codeReader = new ZXing.BrowserBarcodeReader(hints);

    async function loadData() {
        try {
            const res = await fetch(API_URL); const data = await res.json();
            globalProds = {}; data.forEach(i => { if(i.Barcode) globalProds[i.Barcode.toString().trim()] = { name: i.Name, price: parseInt(i.Price) }; });
            localStorage.setItem('huong_ngai_cache', JSON.stringify(globalProds));
            document.getElementById("status-dot").style.background = "#34c759"; document.getElementById("status-text").innerText = "ƒê√£ ƒë·ªìng b·ªô Cloud";
        } catch (e) { document.getElementById("status-dot").style.background = "#ff3b30"; document.getElementById("status-text").innerText = "Ch·∫ø ƒë·ªô Offline"; }
    }

    function startScan() {
        const constraints = { video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } } };
        codeReader.decodeFromConstraints(constraints, 'video', (result) => {
            if (result && !scanLock) {
                const code = result.text.trim(); 
                scanLock = true; 
                playBeep();
                if (globalProds[code]) { 
                    addItemToCart(code); 
                    setTimeout(() => scanLock = false, 2000); 
                }
                else { 
                    window.activeBarcode = code; 
                    document.getElementById("new-product-area").style.display = "block"; 
                }
            }
        });
    }

    function showNoCodeInput() {
        currentModalTarget = "price";
        document.getElementById("modal-label").innerText = "Nh·∫≠p gi√° m·∫∑t h√†ng:";
        document.getElementById("modal-field").value = "";
        document.getElementById("num-modal").style.display = "flex";
        document.getElementById("modal-field").focus();
    }

    function showQtyInput(index) {
        currentModalTarget = index;
        document.getElementById("modal-label").innerText = "Nh·∫≠p s·ªë l∆∞·ª£ng:";
        document.getElementById("modal-field").value = cart[index].qty;
        document.getElementById("num-modal").style.display = "flex";
        document.getElementById("modal-field").focus();
    }

    function closeNumModal() { document.getElementById("num-modal").style.display = "none"; }

    function confirmNumModal() {
        const val = document.getElementById("modal-field").value;
        if (!val || isNaN(val)) { closeNumModal(); return; }

        if (currentModalTarget === "price") {
            noCodeCount++;
            let name = noCodeCount === 1 ? "M·∫∑t h√†ng kh√°c" : "M·∫∑t h√†ng kh√°c " + noCodeCount;
            cart.unshift({ 
                barcode: "KM_" + Date.now(), 
                name: name, 
                price: parseInt(val), 
                qty: 1 
            });
        } else {
            cart[currentModalTarget].qty = parseInt(val);
            if (cart[currentModalTarget].qty <= 0) cart.splice(currentModalTarget, 1);
        }
        updateUI();
        closeNumModal();
    }

    function addItemToCart(code) {
        let item = cart.find(i => i.barcode === code);
        if (item) {
            const index = cart.indexOf(item);
            cart.splice(index, 1);
            item.qty++;
            cart.unshift(item);
        } else {
            cart.unshift({ barcode: code, name: globalProds[code].name, price: globalProds[code].price, qty: 1 });
        }
        updateUI();
    }

    function changeQty(i, d) { cart[i].qty += d; if (cart[i].qty <= 0) cart.splice(i, 1); updateUI(); }

    function updateUI() {
        const list = document.getElementById("cart-list");
        if (cart.length === 0) { 
            list.innerHTML = `<p style="text-align:center; color:#999; font-size: 20px;">Ch∆∞a c√≥ h√†ng</p>`; 
            document.getElementById("bill-total").innerText = "0 ‚Ç´"; 
            return; 
        }
        let total = 0;
        list.innerHTML = cart.map((item, index) => {
            total += item.price * item.qty;
            return `<div class="cart-item">
                <div style="flex:1"><b>${item.name}</b><br><small style="font-size: 16px; color: #666;">${item.price.toLocaleString()}ƒë</small></div>
                <div class="qty-controls">
                    <button class="btn-qty" onclick="changeQty(${index}, -1)">-</button>
                    <b style="min-width: 25px; text-align:center; cursor:pointer;" onclick="showQtyInput(${index})">${item.qty}</b>
                    <button class="btn-qty" onclick="changeQty(${index}, 1)">+</button>
                </div>
                <div style="min-width: 110px; text-align: right; font-weight: bold;">${(item.price * item.qty).toLocaleString()}ƒë</div>
            </div>`;
        }).join('');
        document.getElementById("bill-total").innerText = total.toLocaleString() + " ‚Ç´";
    }

    function showBill() {
        if (cart.length === 0) return;
        const now = new Date();
        const timeStr = now.toLocaleTimeString('vi-VN') + " " + now.toLocaleDateString('vi-VN');
        const totalVal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
        saleHistory.unshift({ time: timeStr, total: totalVal });
        document.getElementById("bill-time-val").innerText = timeStr;
        document.getElementById("bill-items-body").innerHTML = cart.map(item => 
            `<tr><td>${item.name}</td><td align="center">${item.qty}</td><td align="right">${(item.price * item.qty).toLocaleString()}</td></tr>`
        ).join('');
        document.getElementById("bill-total-final").innerText = totalVal.toLocaleString() + " ƒë";
        document.getElementById("bill-overlay").style.display = "block";
        fetch(API_URL, { method: 'POST', body: JSON.stringify({ type: "history", time: timeStr, total: Number(totalVal) }) });
    }

    function openHistory() {
        const historyBody = document.getElementById("history-items-body");
        let dayTotal = 0;
        const todayStr = new Date().toLocaleDateString('vi-VN');
        if (saleHistory.length === 0) {
            historyBody.innerHTML = `<tr><td colspan="2" align="center">Ch∆∞a c√≥ giao d·ªãch</td></tr>`;
        } else {
            historyBody.innerHTML = saleHistory.map(item => {
                if(item.time.includes(todayStr)) dayTotal += item.total;
                return `<tr><td>${item.time}</td><td align="right"><b>${item.total.toLocaleString()} ƒë</b></td></tr>`;
            }).join('');
        }
        document.getElementById("history-day-total").innerText = dayTotal.toLocaleString() + " ‚Ç´";
        document.getElementById("history-overlay").style.display = "block";
    }

    function closeHistory() { document.getElementById("history-overlay").style.display = "none"; }
    function closeBill() { document.getElementById("bill-overlay").style.display = "none"; cart = []; updateUI(); noCodeCount = 0; scanLock = false; }

    async function saveToCloud() {
        const n = document.getElementById("in-name").value, p = document.getElementById("in-price").value;
        if(!n || !p) return;
        globalProds[window.activeBarcode] = { name: n, price: parseInt(p) };
        addItemToCart(window.activeBarcode);
        document.getElementById("new-product-area").style.display = "none";
        document.getElementById("in-name").value = ""; document.getElementById("in-price").value = "";
        fetch(API_URL, { method: 'POST', body: JSON.stringify({ data: [{ Barcode: window.activeBarcode, Name: n, Price: p }] }) });
        setTimeout(() => scanLock = false, 2000);
    }

    window.onload = () => { loadData(); startScan(); };
</script>
</body>
</html>
