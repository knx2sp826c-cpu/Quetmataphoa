<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>T·∫°p Ho√° Ng·∫°i H∆∞·ªùng</title>
    <script src="https://unpkg.com/@zxing/library@0.18.6/bundle/zxing.min.js"></script>
    <style>
        :root { --primary: #007aff; --success: #34c759; --danger: #d70119; --bg: #f2f2f7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; padding-bottom: 120px; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        
        .header { text-align: center; background: white; padding: 15px; border-radius: 15px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .header h1 { margin: 0; color: var(--danger); font-size: 24px; font-weight: 900; }

        /* Camera tinh g·ªçn, kh√¥ng laser */
        #camera-container { width: 100%; height: 200px; background: #000; border-radius: 15px; overflow: hidden; position: relative; margin-bottom: 10px; border: 3px solid var(--primary); }
        video { width: 100%; height: 100%; object-fit: cover; }
        .scan-tip { position: absolute; bottom: 0; width: 100%; text-align: center; color: white; background: rgba(0,0,0,0.5); font-size: 11px; padding: 3px 0; }

        .card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 10px; }
        
        /* √î nh·∫≠p li·ªáu */
        input { width: 100%; font-size: 16px; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        .btn-add { background: var(--success); color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; width: 100%; font-size: 17px; margin-top: 5px; }

        /* Danh s√°ch gi·ªè h√†ng - N√∫t b·∫•m TO */
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f2f2f7; }
        .item-name { flex: 1; font-size: 18px; font-weight: bold; color: #333; }
        .item-name small { font-size: 13px; color: #888; font-weight: normal; }
        
        .qty-control { display: flex; align-items: center; gap: 10px; margin: 0 10px; }
        .btn-qty { width: 45px; height: 45px; background: #e5e5ea; border: none; border-radius: 10px; font-size: 24px; font-weight: bold; color: var(--primary); cursor: pointer; }
        .qty-number { font-size: 24px; font-weight: 900; min-width: 30px; text-align: center; color: #000; }

        /* Thanh thanh to√°n c·ªë ƒë·ªãnh b√™n d∆∞·ªõi */
        .total-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; border-top: 1px solid #ddd; display: flex; flex-direction: column; gap: 8px; z-index: 100; box-shadow: 0 -5px 10px rgba(0,0,0,0.05); }
        .total-row { display: flex; justify-content: space-between; font-size: 22px; font-weight: 900; color: var(--danger); }
        .btn-pay { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 12px; font-size: 18px; font-weight: bold; text-transform: uppercase; cursor: pointer; }

        #new-product-area { display: none; background: #fff9f9; padding: 10px; border-radius: 10px; border: 2px dashed var(--danger); margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="header">
    <h1>üè™ T·∫†P HO√Å NG·∫†I H∆Ø·ªúNG</h1>
</div>

<div id="camera-container">
    <video id="video" playsinline></video>
    <div class="scan-tip">ƒêang s·∫µn s√†ng qu√©t m√£ v·∫°ch...</div>
</div>

<div id="new-product-area">
    <b style="color:var(--danger)">H√†ng m·ªõi! Nh·∫≠p t√™n & gi√°:</b>
    <input id="in-name" type="text" placeholder="T√™n h√†ng m·ªõi..." />
    <input id="in-price" type="number" placeholder="Gi√° b√°n (‚Ç´)" />
    <button class="btn-add" onclick="saveAndAddItem()">‚úîÔ∏è L∆ØU V√Ä TH√äM M√ìN</button>
</div>

<div class="card">
    <div style="font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 8px; font-size: 14px; color: #666;">üì¶ DANH S√ÅCH ƒêANG QU√âT:</div>
    <div id="cart-list">
        <p style="text-align: center; color: #999; padding: 30px;">ƒêang ƒë·ª£i qu√©t m√£ v·∫°ch...</p>
    </div>
</div>

<div class="card" style="margin-bottom: 140px;">
    <div style="font-weight: bold; color: #333;">üìä DOANH THU H√îM NAY: <span id="day-total" style="color: var(--success)">0 ‚Ç´</span></div>
</div>

<div class="total-bar">
    <div class="total-row">
        <span>T·ªîNG:</span>
        <span id="bill-total">0 ‚Ç´</span>
    </div>
    <button class="btn-pay" onclick="finishBill()">‚úÖ XONG KH√ÅCH - L∆ØU ƒê∆†N</button>
</div>

<script>
let globalProducts = JSON.parse(localStorage.getItem("ngaiHuongProducts") || "{}");
let globalBills = JSON.parse(localStorage.getItem("ngaiHuongBills") || "{}");
let currentBill = [];
let currentScannedCode = null;
let scanLock = false;

const codeReader = new ZXing.BrowserBarcodeReader();
const dateKey = new Date().toLocaleDateString("vi-VN");
if (!globalBills[dateKey]) globalBills[dateKey] = [];

// Kh·ªüi ƒë·ªông Camera ngay l·∫≠p t·ª©c
window.addEventListener('load', () => {
    startCamera();
    renderHistory();
});

function startCamera() {
    // T·ªëi ∆∞u frame rate ƒë·ªÉ kh√¥ng gi·∫≠t lag
    const constraints = { video: { facingMode: "environment", frameRate: { ideal: 20 } } };
    codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
        if (result && !scanLock) {
            currentScannedCode = result.text.trim();
            playBeep();
            
            scanLock = true; // Kh√≥a qu√©t ƒë·ªÉ tr√°nh l·∫∑p m√£
            setTimeout(() => { scanLock = false; }, 1500); 

            if (globalProducts[currentScannedCode]) {
                autoAddProduct(globalProducts[currentScannedCode]);
                hideNewArea();
            } else {
                showNewArea();
            }
        }
    });
}

function autoAddProduct(prod) {
    const existing = currentBill.find(i => i.barcode === currentScannedCode);
    if (existing) {
        existing.qty += 1;
    } else {
        currentBill.push({ barcode: currentScannedCode, name: prod.name, price: prod.price, qty: 1 });
    }
    updateUI();
}

function showNewArea() {
    document.getElementById("new-product-area").style.display = "block";
    document.getElementById("in-name").focus();
}

function hideNewArea() {
    document.getElementById("new-product-area").style.display = "none";
    document.getElementById("in-name").value = "";
    document.getElementById("in-price").value = "";
}

function saveAndAddItem() {
    const name = document.getElementById("in-name").value;
    const price = parseInt(document.getElementById("in-price").value);
    if (!name || !price) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß t√™n v√† gi√°!");

    globalProducts[currentScannedCode] = { name: name, price: price };
    localStorage.setItem("ngaiHuongProducts", JSON.stringify(globalProducts));

    autoAddProduct({ name, price });
    hideNewArea();
}

function changeQty(idx, amt) {
    currentBill[idx].qty += amt;
    if (currentBill[idx].qty <= 0) currentBill.splice(idx, 1);
    updateUI();
}

function updateUI() {
    const listEl = document.getElementById("cart-list");
    let total = 0;
    let html = "";

    currentBill.forEach((item, i) => {
        const subTotal = item.price * item.qty;
        total += subTotal;
        html += `
            <div class="item-row">
                <div class="item-name">${item.name}<br><small>${item.price.toLocaleString()}‚Ç´</small></div>
                <div class="qty-control">
                    <button class="btn-qty" onclick="changeQty(${i}, -1)">-</button>
                    <span class="qty-number">${item.qty}</span>
                    <button class="btn-qty" onclick="changeQty(${i}, 1)">+</button>
                </div>
                <div style="font-weight:900; width: 90px; text-align:right; color: #000;">${subTotal.toLocaleString()}‚Ç´</div>
            </div>`;
    });

    listEl.innerHTML = html || '<p style="text-align: center; color: #999; padding: 30px;">ƒêang ƒë·ª£i qu√©t m√£ v·∫°ch...</p>';
    document.getElementById("bill-total").innerText = total.toLocaleString() + " ‚Ç´";
}

function finishBill() {
    if (currentBill.length === 0) return;
    const total = currentBill.reduce((sum, i) => sum + (i.price * i.qty), 0);
    globalBills[dateKey].push({ time: new Date().toLocaleTimeString(), total: total });
    localStorage.setItem("ngaiHuongBills", JSON.stringify(globalBills));
    
    currentBill = [];
    updateUI();
    renderHistory();
    alert("ƒê√£ l∆∞u ƒë∆°n h√†ng th√†nh c√¥ng!");
}

function renderHistory() {
    let daySum = 0;
    if (globalBills[dateKey]) {
        daySum = globalBills[dateKey].reduce((sum, b) => sum + b.total, 0);
    }
    document.getElementById("day-total").innerText = daySum.toLocaleString() + " ‚Ç´";
}

function playBeep() {
    try {
        const context = new (window.AudioContext || window.webkitAudioContext)();
        const osc = context.createOscillator();
        osc.type = "sine";
        osc.frequency.setValueAtTime(800, context.currentTime);
        osc.connect(context.destination);
        osc.start();
        osc.stop(context.currentTime + 0.1);
    } catch (e) {}
}
</script>
</body>
</html>
