<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>T·∫°p Ho√° Ng·∫°i H∆∞·ªùng</title>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<style>
  :root { --primary: #007aff; --success: #34c759; --danger: #ff3b30; --bg: #f2f2f7; }
  body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; padding-bottom: 100px; }
  
  .header { text-align: center; background: white; padding: 15px; border-radius: 15px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  .header h1 { margin: 0; color: #d70119; font-size: 26px; }

  /* Khu v·ª±c Camera lu√¥n hi·ªán */
  #camera-container { width: 100%; height: 200px; background: #000; border-radius: 15px; overflow: hidden; position: relative; margin-bottom: 10px; border: 3px solid var(--primary); }
  video { width: 100%; height: 100%; object-fit: cover; }
  .scan-tip { position: absolute; bottom: 5px; width: 100%; text-align: center; color: white; background: rgba(0,0,0,0.5); font-size: 12px; }

  .card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 10px; }
  
  /* √î nh·∫≠p d·ªØ li·ªáu to r√µ */
  input { width: 100%; font-size: 18px; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
  .btn-add { background: var(--success); color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; width: 100%; font-size: 18px; margin-top: 5px; }

  /* Gi·ªè h√†ng v√† S·ªë l∆∞·ª£ng TO */
  .item-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 2px solid #f2f2f7; }
  .item-name { flex: 1; font-size: 20px; font-weight: bold; }
  
  .qty-control { display: flex; align-items: center; gap: 15px; }
  .btn-qty { width: 50px; height: 50px; background: #e5e5ea; border: none; border-radius: 12px; font-size: 30px; font-weight: bold; color: var(--primary); }
  .qty-number { font-size: 35px; font-weight: 900; min-width: 40px; text-align: center; color: #000; }

  .total-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; border-top: 2px solid #ddd; display: flex; flex-direction: column; gap: 10px; z-index: 100; }
  .total-row { display: flex; justify-content: space-between; font-size: 24px; font-weight: 900; color: var(--danger); }
  .btn-pay { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px; font-size: 20px; font-weight: bold; }

  /* V√πng nh·∫≠p s·∫£n ph·∫©m m·ªõi (m·∫∑c ƒë·ªãnh ·∫©n) */
  #new-product-area { display: none; border-top: 2px dashed var(--primary); margin-top: 10px; padding-top: 10px; }
</style>
</head>
<body>

<div class="header">
  <h1>üè™ T·∫†P HO√Å NG·∫†I H∆Ø·ªúNG</h1>
</div>

<div id="camera-container">
  <video id="video" playsinline></video>
  <div class="scan-tip">ƒê∆∞a m√£ v·∫°ch v√†o khung h√¨nh ƒë·ªÉ qu√©t</div>
</div>

<div class="card">
  <div id="new-product-area">
    <b style="color:var(--danger)">M√£ m·ªõi ch∆∞a l∆∞u! Nh·∫≠p th√¥ng tin:</b>
    <input id="in-name" type="text" placeholder="T√™n h√†ng m·ªõi..." />
    <input id="in-price" type="number" placeholder="Gi√° b√°n (‚Ç´)" />
    <button class="btn-add" onclick="saveAndAddItem()">‚úîÔ∏è L∆ØU V√Ä TH√äM M√ìN</button>
  </div>

  <div class="cart-title" style="font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 5px;">üì¶ GI·ªé H√ÄNG ƒêANG QU√âT:</div>
  <div id="cart-list">
    <p style="text-align: center; color: #999; padding: 20px;">ƒêang ƒë·ª£i qu√©t m√£...</p>
  </div>
</div>

<div class="card">
  <div style="font-weight: bold;">üìä DOANH THU H√îM NAY: <span id="day-total">0 ‚Ç´</span></div>
</div>

<div class="total-bar">
  <div class="total-row">
    <span>T·ªîNG:</span>
    <span id="bill-total">0 ‚Ç´</span>
  </div>
  <button class="btn-pay" onclick="finishBill()">‚úÖ XONG KH√ÅCH - L∆ØU ƒê∆†N</button>
</div>

<script>
let globalProducts = JSON.parse(localStorage.getItem("ngaiHuongProducts") || "{}");
let globalBills = JSON.parse(localStorage.getItem("ngaiHuongBills") || "{}");
let currentBill = [];
let currentScannedCode = null;

const codeReader = new ZXing.BrowserBarcodeReader();
const dateKey = new Date().toLocaleDateString("vi-VN");
if (!globalBills[dateKey]) globalBills[dateKey] = [];

// T·ª∞ ƒê·ªòNG B·∫¨T CAMERA KHI V√ÄO APP
window.addEventListener('load', () => {
  startContinuousScan();
  renderHistory();
});

function startContinuousScan() {
  codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
    if (result) {
      // Khi qu√©t ƒë∆∞·ª£c m√£
      currentScannedCode = result.text;
      playBeep(); // Ph√°t ti·∫øng k√™u b√≠p (n·∫øu mu·ªën)
      
      if (globalProducts[currentScannedCode]) {
        // N·∫øu l√† h√†ng c≈©: T·ª± ƒë·ªông th√™m v√†o gi·ªè lu√¥n
        autoAddProduct(globalProducts[currentScannedCode]);
        hideNewArea();
      } else {
        // N·∫øu l√† h√†ng m·ªõi: Hi·ªán √¥ nh·∫≠p li·ªáu
        showNewArea();
      }
    }
  });
}

function autoAddProduct(prod) {
  const existing = currentBill.find(i => i.barcode === currentScannedCode);
  if (existing) {
    existing.qty += 1;
  } else {
    currentBill.push({ barcode: currentScannedCode, name: prod.name, price: prod.price, qty: 1 });
  }
  updateUI();
}

function showNewArea() {
  document.getElementById("new-product-area").style.display = "block";
  document.getElementById("in-name").focus();
}

function hideNewArea() {
  document.getElementById("new-product-area").style.display = "none";
  document.getElementById("in-name").value = "";
  document.getElementById("in-price").value = "";
}

function saveAndAddItem() {
  const name = document.getElementById("in-name").value;
  const price = parseInt(document.getElementById("in-price").value);
  if (!name || !price) return alert("Nh·∫≠p ƒë·ªß t√™n v√† gi√°!");

  // L∆∞u v√†o t·ª´ ƒëi·ªÉn
  globalProducts[currentScannedCode] = { name: name, price: price };
  localStorage.setItem("ngaiHuongProducts", JSON.stringify(globalProducts));

  // Th√™m v√†o gi·ªè
  autoAddProduct({ name, price });
  hideNewArea();
}

function changeQty(idx, amt) {
  currentBill[idx].qty += amt;
  if (currentBill[idx].qty <= 0) currentBill.splice(idx, 1);
  updateUI();
}

function updateUI() {
  const listEl = document.getElementById("cart-list");
  let total = 0;
  let html = "";

  currentBill.forEach((item, i) => {
    const subTotal = item.price * item.qty;
    total += subTotal;
    html += `
      <div class="item-row">
        <div class="item-name">${item.name}<br><small>${item.price.toLocaleString()}‚Ç´</small></div>
        <div class="qty-control">
          <button class="btn-qty" onclick="changeQty(${i}, -1)">-</button>
          <span class="qty-number">${item.qty}</span>
          <button class="btn-qty" onclick="changeQty(${i}, 1)">+</button>
        </div>
        <div style="font-weight:bold; width: 80px; text-align:right">${subTotal.toLocaleString()}‚Ç´</div>
      </div>`;
  });

  listEl.innerHTML = html || '<p style="text-align: center; color: #999; padding: 20px;">ƒêang ƒë·ª£i qu√©t m√£...</p>';
  document.getElementById("bill-total").innerText = total.toLocaleString() + " ‚Ç´";
}

function finishBill() {
  if (currentBill.length === 0) return;
  const total = currentBill.reduce((sum, i) => sum + (i.price * i.qty), 0);
  globalBills[dateKey].push({ time: new Date().toLocaleTimeString(), total: total });
  localStorage.setItem("ngaiHuongBills", JSON.stringify(globalBills));
  
  currentBill = [];
  updateUI();
  renderHistory();
  alert("Xong! ƒê√£ l∆∞u h√≥a ƒë∆°n.");
}

function renderHistory() {
  let daySum = 0;
  if (globalBills[dateKey]) {
    daySum = globalBills[dateKey].reduce((sum, b) => sum + b.total, 0);
  }
  document.getElementById("day-total").innerText = daySum.toLocaleString() + " ‚Ç´";
}

function playBeep() {
  const context = new (window.AudioContext || window.webkitAudioContext)();
  const osc = context.createOscillator();
  osc.type = "sine";
  osc.frequency.setValueAtTime(800, context.currentTime);
  osc.connect(context.destination);
  osc.start();
  osc.stop(context.currentTime + 0.1);
}
</script>
</body>
</html>
